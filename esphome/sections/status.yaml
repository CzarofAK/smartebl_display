# ============================================
# SmartEBL Display - Status Section
# ============================================
# Status overview with all fuses and tank levels
#
# Import in your main.yaml:
#   packages:
#     status: github://CzarofAK/smartebl_display/esphome/sections/status.yaml@main

# ============================================
# FUSES (18 pieces - Example for 6)
# ============================================
# Extend this to all 18 fuses!

binary_sensor:
  # Fuse 1
  - platform: homeassistant
    id: status_sich_1
    entity_id: binary_sensor.fuse_1_main  # ← CUSTOMIZE
    name: "Fuse 1 Main"
    on_state:
      then:
        - lambda: |-
            int color = x ? 63488 : 2016;  // Red if blown, Green if OK
            id(nextion_display).set_component_value("sich_1.pco", color);

  # Fuse 2
  - platform: homeassistant
    id: status_sich_2
    entity_id: binary_sensor.fuse_2_lights  # ← CUSTOMIZE
    name: "Fuse 2 Lights"
    on_state:
      then:
        - lambda: |-
            int color = x ? 63488 : 2016;
            id(nextion_display).set_component_value("sich_2.pco", color);

  # Fuse 3
  - platform: homeassistant
    id: status_sich_3
    entity_id: binary_sensor.fuse_3_water  # ← CUSTOMIZE
    name: "Fuse 3 Water"
    on_state:
      then:
        - lambda: |-
            int color = x ? 63488 : 2016;
            id(nextion_display).set_component_value("sich_3.pco", color);

  # Fuse 4
  - platform: homeassistant
    id: status_sich_4
    entity_id: binary_sensor.fuse_4_heater  # ← CUSTOMIZE
    name: "Fuse 4 Heater"
    on_state:
      then:
        - lambda: |-
            int color = x ? 63488 : 2016;
            id(nextion_display).set_component_value("sich_4.pco", color);

  # Fuse 5
  - platform: homeassistant
    id: status_sich_5
    entity_id: binary_sensor.fuse_5_12v_aux  # ← CUSTOMIZE
    name: "Fuse 5 12V Aux"
    on_state:
      then:
        - lambda: |-
            int color = x ? 63488 : 2016;
            id(nextion_display).set_component_value("sich_5.pco", color);

  # Fuse 6
  - platform: homeassistant
    id: status_sich_6
    entity_id: binary_sensor.fuse_6_refrigerator  # ← CUSTOMIZE
    name: "Fuse 6 Fridge"
    on_state:
      then:
        - lambda: |-
            int color = x ? 63488 : 2016;
            id(nextion_display).set_component_value("sich_6.pco", color);

  # ========================================
  # ADD FUSES 7-18 HERE
  # ========================================
  # Just copy the block above and change:
  # - id: status_sich_7
  # - entity_id: binary_sensor.fuse_7_xxx
  # - name: "Fuse 7 XXX"
  # - set_component_value("sich_7.pco", color)

# ============================================
# TANK LEVELS
# ============================================

sensor:
  # Fresh Water Tank
  - platform: homeassistant
    id: tank_fresh_water
    entity_id: sensor.fresh_water_tank  # ← CUSTOMIZE
    name: "Fresh Water"
    unit_of_measurement: "L"
    on_value:
      then:
        - lambda: |-
            // Calculate percentage (adjust for your tank size)
            float tank_max = 100.0;  // 100L Tank ← CUSTOMIZE
            float percent = (x / tank_max) * 100.0;

            // Color based on level
            int color = 2016;  // Green
            if (percent < 20) {
              color = 63488;  // Red
            } else if (percent < 40) {
              color = 64512;  // Orange
            }

            // Update Display
            char buffer[20];
            snprintf(buffer, sizeof(buffer), "%.0fL (%.0f%%)", x, percent);
            id(nextion_display).set_component_text("tank_fresh", buffer);
            id(nextion_display).set_component_value("tank_fresh.pco", color);

  # Gray Water Tank
  - platform: homeassistant
    id: tank_gray_water
    entity_id: sensor.gray_water_tank  # ← CUSTOMIZE
    name: "Gray Water"
    unit_of_measurement: "L"
    on_value:
      then:
        - lambda: |-
            float tank_max = 70.0;  // 70L Tank ← CUSTOMIZE
            float percent = (x / tank_max) * 100.0;

            // For gray water: Red when FULL (> 80%)
            int color = 2016;  // Green
            if (percent > 80) {
              color = 63488;  // Red (almost full!)
            } else if (percent > 60) {
              color = 64512;  // Orange (getting full)
            }

            char buffer[20];
            snprintf(buffer, sizeof(buffer), "%.0fL (%.0f%%)", x, percent);
            id(nextion_display).set_component_text("tank_gray", buffer);
            id(nextion_display).set_component_value("tank_gray.pco", color);

  # Black Water Tank
  - platform: homeassistant
    id: tank_black_water
    entity_id: sensor.black_water_tank  # ← CUSTOMIZE
    name: "Black Water"
    unit_of_measurement: "L"
    on_value:
      then:
        - lambda: |-
            float tank_max = 60.0;  // 60L Tank ← CUSTOMIZE
            float percent = (x / tank_max) * 100.0;

            // For black water: Red when FULL
            int color = 2016;  // Green
            if (percent > 80) {
              color = 63488;  // Red
            } else if (percent > 60) {
              color = 64512;  // Orange
            }

            char buffer[20];
            snprintf(buffer, sizeof(buffer), "%.0fL (%.0f%%)", x, percent);
            id(nextion_display).set_component_text("tank_black", buffer);
            id(nextion_display).set_component_value("tank_black.pco", color);

  # LPG Tank (Gas)
  - platform: homeassistant
    id: tank_lpg
    entity_id: sensor.lpg_tank  # ← CUSTOMIZE
    name: "LPG Tank"
    unit_of_measurement: "kg"
    on_value:
      then:
        - lambda: |-
            float tank_max = 8.0;  // 8kg Tank ← CUSTOMIZE
            float percent = (x / tank_max) * 100.0;

            int color = 2016;  // Green
            if (percent < 10) {
              color = 63488;  // Red (almost empty!)
            } else if (percent < 25) {
              color = 64512;  // Orange (low)
            }

            char buffer[20];
            snprintf(buffer, sizeof(buffer), "%.1fkg (%.0f%%)", x, percent);
            id(nextion_display).set_component_text("tank_lpg", buffer);
            id(nextion_display).set_component_value("tank_lpg.pco", color);

# ============================================
# NEXTION COMPONENTS (Reference)
# ============================================
#
# Required on Status_1 Page:
#
# FUSES (Grid Layout):
# - Text "sich_1" to "sich_18"
#   Position: 3 columns x 6 rows
#   Text: "Fuse.1 Main", "Fuse.2 Lights", etc.
#   Color: Dynamic (Green OK / Red Blown)
#
# TANKS:
# - Text "tank_fresh"  → Fresh Water Level
# - Text "tank_gray"   → Gray Water Level
# - Text "tank_black"  → Black Water Level
# - Text "tank_lpg"    → LPG Level
#
# ELECTRICAL STATUS (optional on Status_2):
# - Text "bat_status"  → Battery Voltage & SOC
# - Text "solar_status" → Solar Power
# - Text "shore_status" → Shore Connected/Disconnected

# ============================================
# SCRIPT: Update all status components
# ============================================

script:
  - id: update_status_page
    mode: restart
    then:
      - lambda: |-
          // Automatically called on sensor updates
          // Additional logic here if needed
          ESP_LOGI("status", "Status page updated");

# ============================================
# CUSTOMIZATION NOTES
# ============================================
#
# 1. Extend fuses to 18 (or your number)
#
# 2. Customize tank sizes (tank_max variables)
#
# 3. Adjust thresholds:
#    Fresh Water: < 20% = Red
#    Gray/Black:  > 80% = Red (full!)
#    LPG:         < 10% = Red
#
# 4. Add more sensors (e.g. Diesel Tank)
#
# 5. Optional: Battery status on Status_2 Page
