# ============================================
# SmartEBL Display - Power Section
# ============================================
# Template for energy management (consumption, generation, etc.)
#
# Import in your main.yaml:
#   packages:
#     power: github://CzarofAK/smartebl_display/esphome/sections/power.yaml@main

# ============================================
# TEMPLATE - CUSTOMIZATION REQUIRED!
# ============================================

# ============================================
# ENERGY SENSORS
# ============================================

sensor:
  # Total Power Consumption
  - platform: homeassistant
    id: power_consumption
    entity_id: sensor.total_power  # ← CUSTOMIZE
    name: "Power Consumption"
    unit_of_measurement: "W"
    on_value:
      then:
        - lambda: |-
            char buffer[10];
            snprintf(buffer, sizeof(buffer), "%.0fW", x);
            id(nextion_display).set_component_text("power_cons", buffer);

  # Power Generation (Solar + Alternator)
  - platform: homeassistant
    id: power_generation
    entity_id: sensor.total_generation  # ← CUSTOMIZE
    name: "Power Generation"
    unit_of_measurement: "W"
    on_value:
      then:
        - lambda: |-
            char buffer[10];
            snprintf(buffer, sizeof(buffer), "%.0fW", x);
            id(nextion_display).set_component_text("power_gen", buffer);

  # Net Power (Generation - Consumption)
  - platform: template
    id: power_net
    lambda: |-
      return id(power_generation).state - id(power_consumption).state;
    update_interval: 5s
    on_value:
      then:
        - lambda: |-
            char buffer[15];
            if (x > 0) {
              snprintf(buffer, sizeof(buffer), "+%.0fW", x);
            } else {
              snprintf(buffer, sizeof(buffer), "%.0fW", x);
            }
            id(nextion_display).set_component_text("power_net", buffer);

            // Color: Green if positive, Red if negative
            int color = (x >= 0) ? 2016 : 63488;
            id(nextion_display).set_component_value("power_net.pco", color);

  # Energy Today (kWh)
  - platform: homeassistant
    id: energy_today
    entity_id: sensor.energy_today  # ← CUSTOMIZE
    name: "Energy Today"
    unit_of_measurement: "kWh"
    on_value:
      then:
        - lambda: |-
            char buffer[10];
            snprintf(buffer, sizeof(buffer), "%.1fkWh", x);
            id(nextion_display).set_component_text("energy_today", buffer);

# ============================================
# CONSUMERS (TOP 5)
# ============================================

sensor:
  # Refrigerator
  - platform: homeassistant
    id: power_fridge
    entity_id: sensor.fridge_power  # ← CUSTOMIZE
    on_value:
      then:
        - lambda: |-
            char buffer[10];
            snprintf(buffer, sizeof(buffer), "%.0fW", x);
            id(nextion_display).set_component_text("cons_fridge", buffer);

  # Heater
  - platform: homeassistant
    id: power_heater
    entity_id: sensor.heater_power  # ← CUSTOMIZE
    on_value:
      then:
        - lambda: |-
            char buffer[10];
            snprintf(buffer, sizeof(buffer), "%.0fW", x);
            id(nextion_display).set_component_text("cons_heater", buffer);

  # Water Pump
  - platform: homeassistant
    id: power_pump
    entity_id: sensor.pump_power  # ← CUSTOMIZE
    on_value:
      then:
        - lambda: |-
            char buffer[10];
            snprintf(buffer, sizeof(buffer), "%.0fW", x);
            id(nextion_display).set_component_text("cons_pump", buffer);

  # Inverter
  - platform: homeassistant
    id: power_inverter
    entity_id: sensor.inverter_load  # ← CUSTOMIZE
    on_value:
      then:
        - lambda: |-
            char buffer[10];
            snprintf(buffer, sizeof(buffer), "%.0fW", x);
            id(nextion_display).set_component_text("cons_inverter", buffer);

# ============================================
# NEXTION COMPONENTS (Reference)
# ============================================
#
# Required on Power_1 Page:
# - Text "power_cons"      → Total Consumption
# - Text "power_gen"       → Total Generation
# - Text "power_net"       → Net Power (Green/Red)
# - Text "energy_today"    → Energy Today
#
# On Power_2 Page (Top Consumers):
# - Text "cons_fridge"     → Refrigerator
# - Text "cons_heater"     → Heater
# - Text "cons_pump"       → Pump
# - Text "cons_inverter"   → Inverter
# - Text "cons_other"      → Other

# ============================================
# CUSTOMIZATION NOTES
# ============================================
#
# 1. Replace all entity_id with your Home Assistant Entities
# 2. Add more consumers following the same pattern
# 3. Optional: Chart for history (Nextion Waveform)
# 4. Optional: Cost calculation (kWh x price)
